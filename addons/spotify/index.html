<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'" />

		<title>Spotify</title>

		<link id="config_stylesheet" rel="stylesheet" />
		<style type="text/css">
			.has-addons .button {
				border-color: #444;
			}
		</style>
	</head>

	<body>
		<div class="container">
			<section class="hero is-small has-background-grey-dark">
				<div class="hero-body">
					<p class="subtitle is-size-6 has-text-white-ter">Links with Spotify for scripts requiring its functionality.</p>
				</div>
			</section>

			<div class="m-5">
				<div class="field is-horizontal is-narrow mt-2 mb-5 p-2">
					<div class="field-label is-normal">
						<label class="label">Client ID:</label>
					</div>
					<div class="field-body">
						<div class="field client_id">
							<div class="control ml-6 pl-6">
								<input class="input has-text-centered" type="text" />
							</div>
						</div>
					</div>
				</div>

				<div class="field is-horizontal is-narrow mt-2 mb-5 p-2">
					<div class="field-label is-normal">
						<label class="label">Client Secret:</label>
					</div>
					<div class="field-body">
						<div class="field client_secret">
							<div class="control ml-6 pl-6">
								<input class="input has-text-centered" type="text" />
							</div>
						</div>
					</div>
				</div>

				<div class="field is-horizontal is-narrow mt-2 mb-5 p-2">
					<div class="field-label is-normal">
						<label class="label">Access Token:</label>
					</div>
					<div class="field-body">
						<div class="field has-addons access_token">
							<div class="control ml-6 pl-6 is-expanded">
								<input class="input has-text-centered is-two-thirds" type="password" />
							</div>
							<div class="control">
								<a class="button is-dark">
									Generate
								</a>
							</div>
						</div>
					</div>
				</div>

				<div class="field is-horizontal is-narrow mt-2 mb-5 p-2">
					<div class="field-label is-normal">
						<label class="label">Refresh Token:</label>
					</div>
					<div class="field-body">
						<div class="field refresh_token">
							<div class="control ml-6 pl-6">
								<input class="input has-text-centered" type="password" />
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript">
			let timeout = 0;

			for (const name of ['client_id', 'client_secret', 'access_token', 'refresh_token'])
			{
				const elem = document.querySelector(`.${name} input`);
				const callback = event => {
					let data = {};
					data[name] = elem.value;

					window.parent.postMessage(data, '*');
				};

				elem.addEventListener('blur', callback);
				elem.addEventListener('input', event => {
					clearTimeout(timeout);
					timeout = setTimeout(() => {
						window.parent.postMessage({refresh: true}, '*');
					}, 5000);
				});
			}

			window.addEventListener('message', event => {
				if (event.origin !== 'null')
				{
					if (event.data.name == 'config')
					{
						const _config = event.data.data;

						for (const name of ['client_id', 'client_secret', 'access_token', 'refresh_token'])
							document.querySelector(`.${name} input`).value = _config.connection[name];

						document.querySelector('.access_token .button').setAttribute('external-link', _config.authorize);
					}
				}
			}, false);
		</script>
	</body>

</html>
